#define F_CPU 16000000UL
#include <avr/io.h>
#include <util/delay.h>
#include <stdint.h>

/* Pines: LCD RS=PB0, E=PB1, D4..D7=PD4..PD7; Teclado L1..L4=PC0..PC3, C1..C4=PB2..PB5 */

#define PONER_BIT(p,b)   ((p) |=  (1U<<(b)))
#define BORRAR_BIT(p,b)  ((p) &= ~(1U<<(b)))

/* - LCD --- */
static void lcd_pulso(void){
	PONER_BIT(PORTB, PB1);
	_delay_us(40);
	BORRAR_BIT(PORTB, PB1);
	_delay_us(40);
}

static void lcd_escribir_nibble(uint8_t n){            /* n en [3..0] */
	n = (n & 0x0F) << 4;                               /* PD7..PD4 */
	uint8_t p = PORTD;
	p = (p & 0x0F) | n;
	PORTD = p;
	lcd_pulso();
}

static void lcd_escribir_byte(uint8_t rs, uint8_t b){  /* rs: 0=cmd, 1=dato */
	if(rs) PONER_BIT(PORTB, PB0); else BORRAR_BIT(PORTB, PB0);
	lcd_escribir_nibble(b >> 4);
	lcd_escribir_nibble(b & 0x0F);
	if(rs) _delay_us(50); else _delay_ms(2);
}
