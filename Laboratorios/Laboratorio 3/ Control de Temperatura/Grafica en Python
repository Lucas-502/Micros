import argparse, csv, re, sys, threading, time
from datetime import datetime

import matplotlib.pyplot as plt
import serial
from serial.serialutil import SerialException, PortNotOpenError
from serial.tools import list_ports

# CLI args 
ap = argparse.ArgumentParser(description="Grafica temp y envia comandos por UART")
ap.add_argument("--port", required=True, help="Puerto serie (ej: COM6 o /dev/ttyACM0)")
ap.add_argument("--baud", type=int, default=9600, help="Baudrate (def 9600)")
ap.add_argument("--csv", default="log_temp.csv", help="Archivo CSV de salida")
ap.add_argument("--mid", type=int, default=26, help="Punto medio inicial para dibujar banda")
ap.add_argument("--bw",  type=int, default=4,  help="Media-banda inicial para dibujar banda")
args = ap.parse_args()

# Estado local solo grafico
mid = args.mid
bw  = args.bw
_band_dirty = False          #  se actualiza en hilos, la dibuja el hilo principal

# Terminador de línea que espera el firmware (CR+LF)
LINE_END = "\r\n"

# Zonas y parser de la linea de telemetria del firmware:
# ejemplo: "Temp=27 C | ZONE=LOW | OUT=255"
RX_FULL = re.compile(r"Temp=(\d+)\s+C\s+\|\s+ZONE=(\w+)\s+\|\s+OUT=(\d+)")
ZONE_MAP = {"HEAT":0, "OK":1, "LOW":2, "MED":3, "HIGH":4}
FAN_FROM_ZONE = {0:0, 1:0, 2:1, 3:2, 4:3}  # nivel 0..3 para graficar
