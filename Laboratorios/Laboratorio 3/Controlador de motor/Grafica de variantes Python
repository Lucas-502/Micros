PORT = None            
BAUD = 115200
READ_TIMEOUT_S = 0.05
WINDOW_SAMPLES = 800
SAVE_CSV = False

from serial.tools import list_ports
import serial, time, csv, datetime
from collections import deque
import matplotlib.pyplot as plt
from matplotlib.animation import FuncAnimation

def pick_port(user_port: str | None):
    ports = list(list_ports.comports())
    if user_port:
        return user_port, ports
    prefer = []
    for p in ports:
        desc = f"{p.description} {p.hwid}".lower()
        score = 0
        if "arduino" in desc: score += 3
        if "ch340"  in desc or "wchusb" in desc: score += 2
        if "ftdi"   in desc: score += 2
        if "usb"    in desc: score += 1
        prefer.append((score, p.device, p.description))
    if not prefer:
        raise RuntimeError("No se encontró ningún puerto serie. Conectá el Arduino.")
    prefer.sort(reverse=True)
    return prefer[0][1], ports

def open_serial(port, baud, timeout):
    dev, ports = pick_port(port)
    print("[INFO] Puertos detectados:")
    for p in ports:
        print(f"  - {p.device:>6}  {p.description}")
    print(f"[INFO] Intentando abrir: {dev} @ {baud}")
    try:
        ser = serial.Serial(dev, baudrate=baud, timeout=timeout)
        try:
            ser.dtr = False
            ser.rts = False
            time.sleep(0.3)
        except Exception:
            pass
        ser.reset_input_buffer()
        return ser, dev
    except Exception as e:
        raise SystemExit(f"[ERROR] No pude abrir el puerto {dev}: {e}\n"
                         "Cerrá el Monitor Serie del IDE y probá de nuevo.")


