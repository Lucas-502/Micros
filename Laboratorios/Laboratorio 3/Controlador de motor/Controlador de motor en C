#ifndef F_CPU
#define F_CPU 16000000UL
#endif
#include <avr/io.h>
#include <util/delay.h>
#include <stdint.h>

//UART 115200
static void uart_init(uint32_t b){
    uint16_t u = (uint16_t)(F_CPU/(8UL*b) - 1UL);  
    UBRR0H = (uint8_t)(u >> 8);
    UBRR0L = (uint8_t)(u & 0xFF);
    UCSR0A = (1<<U2X0);                  
    UCSR0B = (1<<TXEN0);                
    UCSR0C = (1<<UCSZ01) | (1<<UCSZ00);  
}

//TX
static inline void pch(char c){ while(!(UCSR0A & (1<<UDRE0))); UDR0 = c; }
static void ps(const char *s){ while(*s) pch(*s++); }
static void pu32(uint32_t v){
    char b[11]; int i = 10; b[i] = 0;
    if(!v){ pch('0'); return; }
    while(v && i){ b[--i] = '0' + (v % 10U); v /= 10U; }
    ps(&b[i]);
}
static void pi16(int16_t v){
    if(v < 0){ pch('-'); v = -v; }
    char b[7]; int i = 6; b[i] = 0;
    if(!v){ pch('0'); return; }
    while(v && i){ b[--i] = '0' + (v % 10); v /= 10; }
    ps(&b[i]);
}

//ADC
static void adc_init(void){ ADMUX=(1<<REFS0); ADCSRA=(1<<ADEN)|(1<<ADPS2)|(1<<ADPS1)|(1<<ADPS0); }
static uint16_t adc_read(uint8_t ch){ ADMUX=(ADMUX&0xF0)|(ch&0x0F); ADCSRA|=(1<<ADSC); while(ADCSRA&(1<<ADSC)); return ADC; }

//PWM
static void pwm_init(void){ DDRB|=(1<<PB1); TCCR1A=(1<<WGM10)|(1<<COM1A1); TCCR1B=(1<<WGM12)|(1<<CS11); OCR1A=0; }
static inline void pwm_set(uint8_t v){ OCR1A=v; }

//L293N
static void gpio_init(void){ DDRD|=(1<<PD7); DDRB|=(1<<PB0); }
static inline void motor_coast(void){ PORTD&=~(1<<PD7); PORTB&=~(1<<PB0); }
static inline void motor_brake(void){ PORTD|=(1<<PD7);  PORTB|=(1<<PB0); }
static inline void motor_fwd(void){   PORTD|=(1<<PD7);  PORTB&=~(1<<PB0); }
static inline void motor_rev(void){   PORTD&=~(1<<PD7); PORTB|=(1<<PB0); }

